# Project Context

## Purpose
This is a Terragrunt infrastructure catalog for homelab Proxmox environments. It provides reusable infrastructure components (modules, units, and stacks) for managing Proxmox resources using OpenTofu/Terraform and Terragrunt. The catalog enables declarative infrastructure management with composable, reusable building blocks.

## Tech Stack
- **OpenTofu**: 1.9.0 (managed via mise)
- **Terragrunt**: 0.78.0 (managed via mise)
- **Go**: 1.24.2 (managed via mise)
- **MinIO Client (mc)**: latest (managed via mise)
- **Proxmox Provider**: bpg/proxmox >= 0.69.0 (NOT telmate/proxmox)
- **Backend**: MinIO (S3-compatible storage)
- **Secrets Management**: SOPS for encrypted environment variables
- **Pre-commit**: Code quality enforcement hooks

## Project Conventions

### Code Style
- **HCL Formatting**: All `.tf` and `.hcl` files must be formatted with `tofu fmt -recursive`
- **File Organization**:
  - Modules: `main.tf`, `variables.tf`, `outputs.tf`, `versions.tf`
  - Units: `terragrunt.hcl` with `include "root"` block
  - Stacks: `terragrunt.stack.hcl` with multiple `unit` blocks
- **Naming Conventions**:
  - Modules: descriptive, lowercase with hyphens (e.g., `proxmox-lxc`, `proxmox-pool`)
  - Variables: snake_case (e.g., `pool_id`, `datastore_id`)
  - Resources: `this` for single-resource modules
- **Git URLs**: Units and stacks use Git URLs in `source` field for external consumption; examples use relative paths (`../../../.././/modules/...`)

### Architecture Patterns
**Three-Layer Architecture:**

1. **Modules** (`modules/`): Raw Terraform/OpenTofu modules
   - Basic building blocks with no Terragrunt-specific logic
   - Define resources, variables, outputs, and provider requirements
   - Examples: `proxmox-lxc`, `proxmox-pool`

2. **Units** (`units/`): Terragrunt wrappers around modules
   - Reference modules via Git URL (for external consumption)
   - Use `values` pattern for parameterization (e.g., `values.hostname`)
   - Can declare dependencies on other units
   - Must include `root.hcl` configuration

3. **Stacks** (`stacks/`): Compositions of multiple units
   - Use `terragrunt.stack.hcl` files
   - Combine multiple units that work together
   - Example: `proxmox-container` combines `proxmox-pool` and `proxmox-lxc`

**Configuration Hierarchy:**
- **Root Configuration** (`examples/terragrunt/root.hcl`): Shared locals for S3 backend and provider configuration
- **Backend Configuration** (`examples/terragrunt/s3-backend.hcl`): MinIO S3-compatible backend settings
- **Provider Configuration** (`examples/terragrunt/provider.hcl`): bpg/proxmox provider configuration

**Dependency Pattern:**
- Units in `examples/` can use `dependency` blocks to reference other units
- Use `mock_outputs` for plan-time execution
- Pass dependency outputs via `inputs` block

### Testing Strategy
- **Module Validation**: Run `tofu validate` after `tofu init` in module directories
- **Pre-commit Hooks**: Automated quality checks on every commit
  - `gitleaks`: Detect hardcoded secrets and credentials
  - `end-of-file-fixer`: Ensure files end with newline
  - `trailing-whitespace`: Remove trailing whitespace
  - `tofu-fmt`: Format all .tf files
  - `tofu-validate`: Validate Terraform syntax and configuration
- **Manual Testing**: Use mise tasks for setup and verification
  - `mise run minio:setup`: Setup MinIO resources
  - `mise run proxmox:setup`: Setup Proxmox resources
  - `mise run terragrunt:cleanup`: Clean cache files

### Git Workflow
- **Main Branch**: `main`
- **Pre-commit Enforcement**: Hooks automatically installed on directory entry via mise
- **Commit Requirements**:
  - All code must pass pre-commit hooks
  - No hardcoded secrets (enforced by gitleaks)
  - All HCL files must be formatted
  - All modules must validate successfully
- **Generated Files**: `backend.tf` and `provider.tf` are auto-generated by Terragrunt and should NOT be committed

## Domain Context

### Proxmox Infrastructure
- **Proxmox VE**: Virtualization platform for managing LXC containers and VMs
- **LXC Containers**: Lightweight Linux containers (unprivileged by default)
- **Resource Pools**: Organizational units for grouping Proxmox resources
- **Datastores**: Storage locations (e.g., `local-lvm` for container disks)
- **Network Bridges**: Virtual network bridges (e.g., `vmbr0` for container networking)
- **Templates**: Pre-built OS images (e.g., `ubuntu-24.04-standard`)

### Backend Storage
- **MinIO**: S3-compatible object storage for Terragrunt state files
- **State Path Pattern**: `${path_relative_to_include()}/tofu.tfstate`
- **Bucket Naming**: `${prefix}-homelab-terragrunt-tfstates`
- **Locking**: Enabled via `use_lockfile = true`

### Authentication
- **Proxmox**: API token authentication via `PROXMOX_VE_API_TOKEN` environment variable
  - Format: `username@realm!tokenname=secret` (single string)
- **MinIO**: Access key and secret via `AWS_ACCESS_KEY_ID` and `AWS_SECRET_ACCESS_KEY`
- **Secrets**: Stored in `.creds.env.yaml` (SOPS-encrypted)

## Important Constraints

### Provider Migration
- **MUST use bpg/proxmox provider** (>= 0.69.0), NOT telmate/proxmox
- **Resource names differ**:
  - LXC: `proxmox_virtual_environment_container` (was `proxmox_lxc`)
  - Pool: `proxmox_virtual_environment_pool` (was `proxmox_pool`)
- **Environment variable changed**: `PROXMOX_VE_API_TOKEN` (was `PM_API_TOKEN_ID` + `PM_API_TOKEN_SECRET`)
- **Network interface naming**: `veth0` (was `eth0`)

### Infrastructure Constraints
- **Homelab Environment**: Limited to local infrastructure (proxmox.home.sflab.io)
- **Single Node**: Currently hardcoded to `pve1` node
- **Fixed Network**: Containers use `vmbr0` bridge with DHCP
- **Ubuntu Only**: Currently supports Ubuntu 24.04 LXC template
- **Unprivileged Containers**: Security preference for container isolation

### Credential Management
- **No Hardcoded Secrets**: Enforced by gitleaks pre-commit hook
- **Environment Variables Required**: Must set before running Terragrunt
- **SOPS Encryption**: All credentials in `.creds.env.yaml` must be encrypted

## External Dependencies

### Services
- **Proxmox VE Server**: `proxmox.home.sflab.io:8006`
  - Provides virtualization platform
  - Requires API token authentication
  - Hosts LXC templates and containers
- **MinIO Server**: `minio.home.sflab.io:9000`
  - S3-compatible backend for Terragrunt state
  - Requires access key and secret key

### Tools and Libraries
- **mise**: Tool version management and task runner
- **SOPS**: Secrets encryption/decryption
- **pre-commit**: Git hook framework
- **gitleaks**: Secret detection

### Required Environment Variables
```bash
# MinIO Backend
export AWS_ACCESS_KEY_ID="your-access-key"
export AWS_SECRET_ACCESS_KEY="your-secret-key"

# Proxmox Provider
export PROXMOX_VE_API_TOKEN="root@pam!tofu=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"

# Module-specific (example)
export TF_VAR_password="your-secure-password"
```
